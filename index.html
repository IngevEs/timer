<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Klokkr</title>
<style>
:root{
  --bg:#f3f4f6; --face:#fff; --sector:#c3b1e1; --passed:#f5c2d6;
  --accent:#8b6bb8; --text:#1f2937; --muted:#6b7280; --button:#a085d6; --dash:#d4d4d8;
  --font-base:16px; --font-large:28px; --shadow-color:rgba(0,0,0,0.08);
}
html,body{height:100%;margin:0;font-family:system-ui,sans-serif;background:var(--bg);color:var(--text);display:flex;flex-direction:column;align-items:center;padding:20px;gap:18px;box-sizing:border-box;}
h1{margin:0;font-size:20px;font-weight:700;color:var(--accent);}
.controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:center;}
label{font-size:16px;color:var(--text);}
input,button,select{border-radius:10px;font-size:16px;padding:10px;border:none;}
input[type=time]{background:var(--face);}
button{background:var(--button);color:#fff;font-weight:700;cursor:pointer;}
.clock-wrap{width:min(420px,86vw);height:min(420px,86vw);display:grid;place-items:center;}
svg{width:100%;height:100%;}
.center-text{text-align:center;}
.big{font-size:var(--font-large);font-weight:800;color:var(--accent);}
.muted{font-size:var(--font-base);color:var(--muted);margin-top:6px;}
.legend{display:flex;gap:12px;align-items:center;margin-top:8px;font-size:14px;color:var(--muted);}
.dot{width:14px;height:14px;border-radius:50%;display:inline-block;}
.dot.school{background:var(--sector);}
.dot.passed{background:var(--passed);}
footer{font-size:13px;color:var(--muted);margin-top:8px;}
.num{font-size:20px;font-weight:700;fill:var(--text);}
.theme-panel{display:none;flex-direction:column;gap:8px;padding:10px;border:1px solid #ccc;border-radius:10px;background:#f9f9f9;}
.theme-panel label{font-size:14px;color:#333;}
@media(max-width:420px){.big{font-size:22px;}input,button,select{font-size:14px;padding:8px 10px;}.num{font-size:16px;}}
</style>
</head>
<body>

<h1>Klokkr</h1>

<!-- Crucial controls always visible -->
<div class="controls" id="crucialControls">
  <label>Start: <input id="start" type="time"></label>
  <label>Eind: <input id="end" type="time"></label>
  <button id="apply">Toon blok</button>
  <button id="now">Zet op nu</button>
  <button id="toggleThemePanel">Themes</button>
</div>

<!-- Theme settings hidden by default -->
<div class="theme-panel" id="themePanel">
  <label>Thema kiezen:
    <select id="themeSelect">
      <option value="">-- Kies thema --</option>
    </select>
  </label>
  <label>Upload JSON theme: <input type="file" id="themeUpload" accept=".json"></label>
</div>

<div class="clock-wrap">
  <svg viewBox="0 0 260 260" id="svg">
    <circle cx="130" cy="130" r="114" fill="none" stroke="rgba(0,0,0,0.06)" stroke-width="1"/>
    <path id="sector" fill="var(--sector)"></path>
    <path id="passed" fill="var(--passed)" opacity="0.95"></path>
    <g id="ticks"></g>
    <g id="numbers"></g>
    <circle cx="130" cy="130" r="4" fill="var(--accent)"/>
  </svg>
</div>

<div class="center-text">
  <div class="big" id="timeNow">--:--:--</div>
  <div class="muted" id="countdown"></div>
  <div class="legend"><span class="dot school"></span><span>schooltijd</span><span class="dot passed"></span><span>verstreken</span></div>
</div>

<script>
(() => {
  const sector = document.getElementById('sector'),
        passed = document.getElementById('passed'),
        timeNow = document.getElementById('timeNow'),
        countdown = document.getElementById('countdown'),
        startInput = document.getElementById('start'),
        endInput = document.getElementById('end'),
        applyBtn = document.getElementById('apply'),
        nowBtn = document.getElementById('now'),
        themeUpload = document.getElementById('themeUpload'),
        themeSelect = document.getElementById('themeSelect'),
        themePanel = document.getElementById('themePanel'),
        toggleThemePanel = document.getElementById('toggleThemePanel'),
        ticksG = document.getElementById('ticks'),
        numsG = document.getElementById('numbers');

  let block = null;

  // --- Built-in themes ---
  const builtInThemes = [
    {name:"Default", colors:{bg:"#f3f4f6",face:"#fff",sector:"#c3b1e1",passed:"#f5c2d6",accent:"#8b6bb8",text:"#1f2937",muted:"#6b7280",button:"#a085d6",dash:"#d4d4d8"}},
    {name:"Dark", colors:{bg:"#1f1f1f",face:"#2a2a2a",sector:"#4b5563",passed:"#6b7280",accent:"#facc15",text:"#f3f4f6",muted:"#9ca3af",button:"#3b82f6",dash:"#374151"}},
    {name:"Sunset", colors:{bg:"#ffedd5",face:"#fff7ed",sector:"#fb923c",passed:"#fecaca",accent:"#f43f5e",text:"#7c2d12",muted:"#b45309",button:"#ea580c",dash:"#c2410c"}},
    {name:"Ocean", colors:{bg:"#dbeafe",face:"#eff6ff",sector:"#3b82f6",passed:"#93c5fd",accent:"#1d4ed8",text:"#1e3a8a",muted:"#1e40af",button:"#2563eb",dash:"#60a5fa"}},
    {name:"Forest", colors:{bg:"#ecfdf5",face:"#f0fdf4",sector:"#22c55e",passed:"#bbf7d0",accent:"#15803d",text:"#065f46",muted:"#10b981",button:"#16a34a",dash:"#4ade80"}},
    {name:"Candy", colors:{bg:"#fff0f6",face:"#fff5f7",sector:"#f472b6",passed:"#fbcfe8",accent:"#db2777",text:"#831843",muted:"#ec4899",button:"#e11d48",dash:"#f9a8d4"}},
    {name:"Coffee", colors:{bg:"#fef3c7",face:"#fff9db",sector:"#a16207",passed:"#fcd34d",accent:"#854d0e",text:"#78350f",muted:"#ca8a04",button:"#d97706",dash:"#fbbf24"}},
    {name:"Violet", colors:{bg:"#f5f3ff",face:"#faf5ff",sector:"#8b5cf6",passed:"#c4b5fd",accent:"#6d28d9",text:"#4c1d95",muted:"#7c3aed",button:"#7c3aed",dash:"#a78bfa"}},
    {name:"Mint", colors:{bg:"#f0fdfa",face:"#dcfce7",sector:"#34d399",passed:"#bbf7d0",accent:"#047857",text:"#065f46",muted:"#10b981",button:"#059669",dash:"#6ee7b7"}},
    {name:"Blush", colors:{bg:"#fff1f2",face:"#ffe4e6",sector:"#f43f5e",passed:"#fbcfe8",accent:"#be123c",text:"#831843",muted:"#ec4899",button:"#db2777",dash:"#f9a8d4"}}
  ];

  // Populate theme dropdown
  builtInThemes.forEach((t,i)=>{
    const opt = document.createElement('option');
    opt.value = i;
    opt.textContent = t.name;
    themeSelect.appendChild(opt);
  });

  // Load saved settings
  const settings = JSON.parse(localStorage.getItem('clockSettings') || '{}');
  if(settings.start) startInput.value = settings.start;
  if(settings.end) endInput.value = settings.end;
  if(settings.colors) applyTheme(settings.colors);

  // Draw ticks and numbers
  for(let h=0;h<12;h++){
    const ang = (h/12)*2*Math.PI - Math.PI/2;
    const x1=130+Math.cos(ang)*100, y1=130+Math.sin(ang)*100,
          x2=130+Math.cos(ang)*110, y2=130+Math.sin(ang)*110;
    const tick = document.createElementNS('http://www.w3.org/2000/svg','line');
    tick.setAttribute('x1',x1); tick.setAttribute('y1',y1); tick.setAttribute('x2',x2); tick.setAttribute('y2',y2);
    tick.setAttribute('stroke','rgba(0,0,0,0.08)'); tick.setAttribute('stroke-width','4'); ticksG.appendChild(tick);

    const num = document.createElementNS('http://www.w3.org/2000/svg','text');
    num.setAttribute('x',130+Math.cos(ang)*74);
    num.setAttribute('y',130+Math.sin(ang)*74+7);
    num.setAttribute('text-anchor','middle'); num.setAttribute('class','num');
    num.textContent = h===0?12:h;
    numsG.appendChild(num);
  }

  const toMinutes = hm => { if(!hm) return null; const [a,b]=hm.split(':').map(Number); return a*60+b; };
  const minuteToAngle = min => (min%(12*60))/(12*60)*2*Math.PI - Math.PI/2;
  const polar = (cx,cy,r,a) => ({x:cx+Math.cos(a)*r, y:cy+Math.sin(a)*r});
  const describe = (cx,cy,r,a1,a2) => {let a2p=a2<=a1?a2+2*Math.PI:a2; const s=polar(cx,cy,r,a1), e=polar(cx,cy,r,a2p); return `M${cx},${cy} L${s.x},${s.y} A${r},${r} 0 ${(a2p-a1)>Math.PI?1:0} 1 ${e.x},${e.y} Z`;};

  function setBlock(start,end){
    const s = toMinutes(start), e = toMinutes(end); if(s==null||e==null) return;
    block = {s, e: e<=s? e+24*60 : e};
    render();
    saveSettings();
  }

  function render(){
    if(!block) return;
    const now = new Date();
    let nowM = now.getHours()*60 + now.getMinutes() + now.getSeconds()/60;
    if(nowM<block.s && block.e>24*60) nowM+=24*60;
    const sa = minuteToAngle(block.s), ea = minuteToAngle(block.e);
    sector.setAttribute('d',describe(130,130,106,sa,ea));
    const total = block.e-block.s, f=(nowM-block.s)/total;
    if(f<=0) passed.setAttribute('d','');
    else if(f>=1) passed.setAttribute('d',describe(130,130,106,sa,ea));
    else passed.setAttribute('d',describe(130,130,106,sa,sa+((ea-sa+(ea<=sa?2*Math.PI:0))*f)));
  }

  function update(){
    const n = new Date();
    timeNow.textContent = n.toLocaleTimeString('nl-NL',{hour12:false});
    if(block){
      let nm = n.getHours()*60+n.getMinutes()+n.getSeconds()/60;
      if(nm<block.s&&block.e>24*60) nm+=24*60;
      const rem = Math.max(0,block.e-nm);
      countdown.textContent = nm<block.s ? `Start over ${Math.ceil(block.s-nm)} min` :
                          nm>block.e ? 'Afgerond' : `Nog ${Math.floor(rem/60)}u ${Math.floor(rem%60)}m`;
    }
    render();
  }

  function saveSettings(){
    const colors = {};
    ['bg','face','sector','passed','accent','text','muted','button','dash'].forEach(v=>{
      colors[v] = getComputedStyle(document.documentElement).getPropertyValue(`--${v}`).trim();
    });
    localStorage.setItem('clockSettings', JSON.stringify({start:startInput.value,end:endInput.value,colors}));
  }

  function applyTheme(theme){
    Object.entries(theme).forEach(([k,v]) => document.documentElement.style.setProperty(`--${k}`,v));
  }

  // Event listeners
  applyBtn.addEventListener('click',()=>{setBlock(startInput.value,endInput.value);update();});
  nowBtn.addEventListener('click',()=>{const n=new Date();startInput.value=`${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}`;});
  
  themeUpload.addEventListener('change', e=>{
    const file = e.target.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = ()=> {
      try{
        const theme = JSON.parse(reader.result);
        applyTheme(theme);
        saveSettings();
      }catch(err){alert('Ongeldige JSON');}
    }
    reader.readAsText(file);
  });

  themeSelect.addEventListener('change', e=>{
    const idx = themeSelect.value;
    if(idx!=='') {applyTheme(builtInThemes[idx].colors); saveSettings();}
  });

  toggleThemePanel.addEventListener('click', ()=>{
    themePanel.style.display = themePanel.style.display==='flex' ? 'none' : 'flex';
  });

  setBlock(startInput.value,endInput.value);
  update();
  setInterval(update,1000);
})();
</script>
</body>
</html>
